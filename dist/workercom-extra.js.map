{"version":3,"file":"workercom-extra.js","sources":["../src/workercom-extra.js"],"sourcesContent":["/* global self, Worker, Blob */\nimport { expose, wrap, createEndpoint, windowEndpoint, installTransfer, releaseProxy } from 'workercom'\n\n// Source: <https://github.com/parcel-bundler/parcel/blob/master/packages/core/parcel-bundler/src/builtins/bundle-url.js>\nlet bundleURL\n\nfunction getBundleURLCached () {\n  if (!bundleURL) {\n    bundleURL = getBundleURL()\n  }\n\n  return bundleURL\n}\n\nfunction getBundleURL () {\n  // Attempt to find the URL of the current script and use that as the base URL\n  try {\n    throw new Error()\n  } catch (err) {\n    const matches = ('' + err.stack).match(/(https?|file|ftp|chrome-extension|moz-extension):\\/\\/[^)\\n]+/g)\n    if (matches) {\n      return getBaseURL(matches[0])\n    }\n  }\n\n  return '/'\n}\n\nfunction getBaseURL (url) {\n  return ('' + url).replace(/^((?:https?|file|ftp|chrome-extension|moz-extension):\\/\\/.+)?\\/[^/]+(?:\\?.*)?$/, '$1') + '/'\n}\n\nconst isAbsoluteURL = (value) => /^[a-zA-Z][a-zA-Z\\d+\\-.]*:/.test(value)\n\nfunction createSourceBlobURL (code) {\n  const blob = new Blob(\n    [code],\n    { type: 'application/javascript' }\n  )\n  return URL.createObjectURL(blob)\n}\n\nclass WebWorker extends Worker {\n  constructor (url, options) {\n    if (typeof url === 'string' && options && options._baseURL) {\n      url = new URL(url, options._baseURL)\n    } else if (typeof url === 'string' && !isAbsoluteURL(url) && getBundleURLCached().match(/^file:\\/\\//i)) {\n      url = new URL(url, getBundleURLCached().replace(/\\/[^/]+$/, '/'))\n      if (options?.CORSWorkaround ?? true) {\n        url = createSourceBlobURL(`importScripts(${JSON.stringify(url)});`)\n      }\n    }\n    if (typeof url === 'string' && isAbsoluteURL(url)) {\n      // Create source code blob loading JS file via `importScripts()`\n      // to circumvent worker CORS restrictions\n      if (options?.CORSWorkaround ?? true) {\n        url = createSourceBlobURL(`importScripts(${JSON.stringify(url)});`)\n      }\n    }\n    super(url, options)\n  }\n}\n\nconst __events = {}\n\nfunction on (event, callback) {\n  if (!__events[event]) {\n    __events[event] = []\n  }\n  __events[event].push(callback)\n}\n\nfunction fire (event, data = {}) {\n  __events[event]?.forEach(callback => {\n    callback(data)\n  })\n}\n\nfunction __expose (value, ep = self) {\n  expose({ exposed: value, on })\n}\n\nfunction __wrap (ep) {\n  const wrappedWorker = wrap(ep)\n  const proxyWorker = new Proxy(wrappedWorker, {\n    apply: function (target, thisArg, argumentsList) {\n      return target.exposed(...argumentsList)\n    },\n    get: function (target, prop, receiver) {\n      return prop === 'on' ? target.on : prop ? target.exposed[prop] : target.exposed\n    }\n  })\n  return proxyWorker\n}\n\nexport { __expose as expose, __wrap as wrap, fire, WebWorker as Worker, createEndpoint, windowEndpoint, installTransfer, releaseProxy }\n"],"names":["bundleURL","getBundleURLCached","getBundleURL","Error","err","matches","stack","match","getBaseURL","url","replace","isAbsoluteURL","value","test","createSourceBlobURL","code","blob","Blob","type","URL","createObjectURL","WebWorker","options","_baseURL","CORSWorkaround","JSON","stringify","Worker","__events","on","event","callback","push","fire","data","forEach","__expose","ep","expose","exposed","__wrap","wrappedWorker","wrap","proxyWorker","Proxy","apply","target","thisArg","argumentsList","get","prop","receiver"],"mappings":"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"}